<div class="add-client-container">
  <mat-card class="client-form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>person_add</mat-icon>
        Ajouter un nouveau client
      </mat-card-title>
      <button mat-icon-button class="close-btn" (click)="onClose()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-header>

    <mat-card-content>
      @if (clientForm) {
      <form
        [formGroup]="clientForm"
        (ngSubmit)="onSubmit()"
        class="client-form"
      >
        <!-- Section Informations personnelles -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>person</mat-icon>
            Informations personnelles
          </h3>

          <div class="form-row">
            <div class="radio-field-container">
              <mat-label class="radio-field-label">Titre</mat-label>
              <mat-radio-group
                formControlName="title"
                class="example-radio-group"
              >
                @for (option of title_choice; track option) {
                <mat-radio-button class="example-radio-button" [value]="option">
                  {{ option }}
                </mat-radio-button>
                }
              </mat-radio-group>
            </div>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nom</mat-label>
              <input matInput formControlName="lastName" required />
              @if(clientForm.get('lastName')?.hasError('required')) {
              <mat-error> Le nom est requis </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Prénom</mat-label>
              <input matInput formControlName="firstName" required />
              @if(clientForm.get('firstName')?.hasError('required')) {
              <mat-error> Le prénom est requis </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email" required />
              <mat-icon matSuffix>email</mat-icon>
              @if(clientForm.get('email')?.hasError('required')) {
              <mat-error> L'email est requis </mat-error>
              } @if(clientForm.get('email')?.hasError('email')) {
              <mat-error> Format d'email invalide </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <div
              class="form-field"
              style="flex: 1; min-width: 200px; margin-right: 8px"
            >
              @if (editingPhoneLabelIndex !== 0) {
                <label
                  class="mat-label editable-label"
                  for="phone1Input"
                  (dblclick)="$event.preventDefault(); $event.stopPropagation(); startEditPhoneLabel(0)"
                  title="Double-cliquer pour modifier"
                >
                  {{ phoneLabels()[0] }}
                </label>
              } @else {
                <input
                  class="label-editor"
                  [value]="labelEditValue"
                  (input)="onLabelInput($event)"
                  (blur)="endEditPhoneLabel()"
                  (keydown.enter)="endEditPhoneLabel()"
                  [style.margin-bottom.px]="4"
                  placeholder="Nom du champ (ex. Téléphone bureau)"
                  autofocus
                />
              }
              <div
                class="mat-like-field"
                [class.ng-invalid]="clientForm.get('phone1')?.invalid"
                [class.ng-touched]="clientForm.get('phone1')?.touched"
              >
                <ngx-intl-tel-input
                  [cssClass]="'custom-intl-input'"
                  [preferredCountries]="[CountryISO.France, CountryISO.Belgium, CountryISO.Switzerland]"
                  [enablePlaceholder]="true"
                  [searchCountryFlag]="true"
                  [selectFirstCountry]="false"
                  [separateDialCode]="true"
                  [phoneValidation]="true"
                  [selectedCountryISO]="CountryISO.France"
                  [maxLength]="15"
                  name="phone1"
                  [inputId]="'phone1Input'"
                  formControlName="phone1"
                  required
                >
                </ngx-intl-tel-input>
              </div>
              @if(clientForm.get('phone1')?.invalid &&
              clientForm.get('phone1')?.touched) {
              <span class="phone-error">
                Le numéro de téléphone 1 n'est pas valide
              </span>
              }
            </div>
            <div
              class="form-field"
              style="flex: 1; min-width: 200px; margin-left: 8px"
            >
              @if (editingPhoneLabelIndex !== 1) {
                <label
                  class="mat-label editable-label"
                  for="phone2Input"
                  (dblclick)="$event.preventDefault(); $event.stopPropagation(); startEditPhoneLabel(1)"
                  title="Double-cliquer pour modifier"
                >
                  {{ phoneLabels()[1] }}
                </label>
              } @else {
                <input
                  class="label-editor"
                  [value]="labelEditValue"
                  (input)="onLabelInput($event)"
                  (blur)="endEditPhoneLabel()"
                  (keydown.enter)="endEditPhoneLabel()"
                  [style.margin-bottom.px]="4"
                  placeholder="Nom du champ (ex. Téléphone bureau)"
                  autofocus
                />
              }
              <div
                class="mat-like-field"
                [class.ng-invalid]="clientForm.get('phone2')?.invalid"
                [class.ng-touched]="clientForm.get('phone2')?.touched"
              >
                <ngx-intl-tel-input
                  [cssClass]="'custom-intl-input'"
                  [preferredCountries]="[CountryISO.France, CountryISO.Belgium, CountryISO.Switzerland]"
                  [enablePlaceholder]="true"
                  [searchCountryFlag]="true"
                  [selectFirstCountry]="false"
                  [separateDialCode]="true"
                  [phoneValidation]="true"
                  [selectedCountryISO]="CountryISO.France"
                  [maxLength]="15"
                  name="phone2"
                  [inputId]="'phone2Input'"
                  formControlName="phone2"
                >
                </ngx-intl-tel-input>
              </div>
              @if(clientForm.get('phone2')?.invalid &&
              clientForm.get('phone2')?.touched) {
              <span class="phone-error">
                Le numéro de téléphone 2 n'est pas valide
              </span>
              }
            </div>
            <div
              class="form-field"
              style="flex: 1; min-width: 200px; margin-left: 8px"
            >
              @if (editingPhoneLabelIndex !== 2) {
                <label
                  class="mat-label editable-label"
                  for="phone3Input"
                  (dblclick)="$event.preventDefault(); $event.stopPropagation(); startEditPhoneLabel(2)"
                  title="Double-cliquer pour modifier"
                >
                  {{ phoneLabels()[2] }}
                </label>
              } @else {
                <input
                  class="label-editor"
                  [value]="labelEditValue"
                  (input)="onLabelInput($event)"
                  (blur)="endEditPhoneLabel()"
                  (keydown.enter)="endEditPhoneLabel()"
                  [style.margin-bottom.px]="4"
                  placeholder="Nom du champ (ex. Téléphone bureau)"
                  autofocus
                />
              }
              <div
                class="mat-like-field"
                [class.ng-invalid]="clientForm.get('phone3')?.invalid"
                [class.ng-touched]="clientForm.get('phone3')?.touched"
              >
                <ngx-intl-tel-input
                  [cssClass]="'custom-intl-input'"
                  [preferredCountries]="[CountryISO.France, CountryISO.Belgium, CountryISO.Switzerland]"
                  [enablePlaceholder]="true"
                  [searchCountryFlag]="true"
                  [selectFirstCountry]="false"
                  [separateDialCode]="true"
                  [phoneValidation]="true"
                  [selectedCountryISO]="CountryISO.France"
                  [maxLength]="15"
                  name="phone3"
                  [inputId]="'phone3Input'"
                  formControlName="phone3"
                >
                </ngx-intl-tel-input>
              </div>
              @if(clientForm.get('phone3')?.invalid &&
              clientForm.get('phone3')?.touched) {
              <span class="phone-error">
                Le numéro de téléphone 3 n'est pas valide
              </span>
              }
            </div>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field-full">
              <mat-label>Code Client</mat-label>
              <input matInput formControlName="codeClient" required />
              @if(clientForm.get('codeClient')?.hasError('required')) {
              <mat-error> Le code client est requis </mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Section Adresse -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>location_on</mat-icon>
            Adresse
          </h3>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field-full">
              <mat-label>Adresse</mat-label>
              <input matInput formControlName="rue" required />
              <mat-icon matSuffix>home</mat-icon>
              @if(clientForm.get('rue')?.hasError('required')) {
              <mat-error> La rue est requise </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Code Postal</mat-label>
              <input
                matInput
                type="number"
                formControlName="code_postal"
                required
              />
              <mat-icon matSuffix>markunread_mailbox</mat-icon>
              @if(clientForm.get('code_postal')?.hasError('required')) {
              <mat-error> Le code postal est requis </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Ville</mat-label>
              <input matInput formControlName="city" required />
              <mat-icon matSuffix>location_city</mat-icon>
              @if(clientForm.get('city')?.hasError('required')) {
              <mat-error> La ville est requise </mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="form-actions">
          <button
            mat-button
            type="button"
            (click)="onReset()"
            class="reset-btn"
          >
            <mat-icon>refresh</mat-icon>
            Réinitialiser
          </button>

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="clientForm.invalid"
            class="submit-btn"
          >
            <mat-icon>save</mat-icon>
            Enregistrer le client
          </button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>
</div>
