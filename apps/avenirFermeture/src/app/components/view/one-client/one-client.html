@if(isLoading){
  <div class="loading-container">
    <mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
    <p>Chargement des informations du client...</p>
  </div>
} @else if(client) {
  <div class="client-container">
    <!-- Header -->
    <div class="client-header">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-info">
        <h1>{{ client.firstName }} {{ client.lastName }}</h1>
        <span class="client-code">{{ client.code_client }}</span>
      </div>
    </div>

    <!-- Main Content with Tabs -->
    <mat-tab-group class="client-tabs">

      <!-- Informations générales -->
      <mat-tab label="Informations générales">
        <div class="tab-content">
          <mat-card class="info-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>person</mat-icon>
              <mat-card-title>Informations personnelles</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <mat-icon>badge</mat-icon>
                  <div>
                    <span class="info-label">Code client</span>
                    <span class="info-value">{{ client.code_client }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>person</mat-icon>
                  <div>
                    <span class="info-label">Nom complet</span>
                    <span class="info-value">{{ client.firstName }} {{ client.lastName }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>email</mat-icon>
                  <div>
                    <span class="info-label">Email</span>
                    <span class="info-value">{{ client.email }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>phone</mat-icon>
                  <div>
                    <span class="info-label">Téléphone</span>
                    <span class="info-value">{{ client.phone }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>location_city</mat-icon>
                  <div>
                    <span class="info-label">Ville</span>
                    <span class="info-value">{{ client.city }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>calendar_today</mat-icon>
                  <div>
                    <span class="info-label">Date de création</span>
                    <span class="info-value">{{ formatDate(client.createdAt) }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Livraison -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>local_shipping</mat-icon>
              <mat-card-title>Informations de livraison</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <mat-icon>event</mat-icon>
                  <div>
                    <span class="info-label">Semaine de livraison souhaitée</span>
                    <span class="info-value">{{ formatWeek(client.semain_livraison_souhaite) }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>event_busy</mat-icon>
                  <div>
                    <span class="info-label">Livraison limite</span>
                    <span class="info-value">{{ formatWeek(client.livraison_limite) }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Paiements -->
      <mat-tab label="Paiements">
        <div class="tab-content">

          <!-- Acompte Métré -->
          <mat-card class="payment-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="payment-icon">payments</mat-icon>
              <mat-card-title>Acompte Métré</mat-card-title>
              <mat-chip [class]="getPaymentStatusClass(client.etat_paiement_acompte_metre)">
                {{ getPaymentStatus(client.etat_paiement_acompte_metre) }}
              </mat-chip>
            </mat-card-header>
            <mat-card-content>
              <div class="payment-details">
                <div class="payment-item">
                  <span class="payment-label">Montant</span>
                  <span class="payment-value amount">{{ formatAmount(client.montant_acompte_metre) }}</span>
                </div>
                <div class="payment-item">
                  <span class="payment-label">Semaine d'envoi de la demande</span>
                  <span class="payment-value">{{ formatWeek(client.semaine_evoi_demande_acompte_metre) }}</span>
                </div>
                @if(client.note_acompte_metre) {
                  <div class="payment-item note">
                    <mat-icon>note</mat-icon>
                    <div>
                      <span class="payment-label">Note</span>
                      <span class="payment-value">{{ client.note_acompte_metre }}</span>
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Acompte Livraison -->
          <mat-card class="payment-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="payment-icon">local_shipping</mat-icon>
              <mat-card-title>Acompte Livraison</mat-card-title>
              <mat-chip [class]="getPaymentStatusClass(client.etat_paiement_acompte_livraison)">
                {{ getPaymentStatus(client.etat_paiement_acompte_livraison) }}
              </mat-chip>
            </mat-card-header>
            <mat-card-content>
              <div class="payment-details">
                <div class="payment-item">
                  <span class="payment-label">Montant</span>
                  <span class="payment-value amount">{{ formatAmount(client.montant_acompte_livraison) }}</span>
                </div>
                <div class="payment-item">
                  <span class="payment-label">Semaine d'envoi de la demande</span>
                  <span class="payment-value">{{ formatWeek(client.semaine_evoi_demande_acompte_livraison) }}</span>
                </div>
                @if(client.note_acompte_livraison) {
                  <div class="payment-item note">
                    <mat-icon>note</mat-icon>
                    <div>
                      <span class="payment-label">Note</span>
                      <span class="payment-value">{{ client.note_acompte_livraison }}</span>
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Solde -->
          <mat-card class="payment-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="payment-icon">account_balance</mat-icon>
              <mat-card-title>Solde</mat-card-title>
              <mat-chip [class]="getPaymentStatusClass(client.etat_paiement_solde)">
                {{ getPaymentStatus(client.etat_paiement_solde) }}
              </mat-chip>
            </mat-card-header>
            <mat-card-content>
              <div class="payment-details">
                <div class="payment-item">
                  <span class="payment-label">Montant</span>
                  <span class="payment-value amount">{{ formatAmount(client.montant_solde) }}</span>
                </div>
                <div class="payment-item">
                  <span class="payment-label">Semaine d'envoi de la demande</span>
                  <span class="payment-value">{{ formatWeek(client.semain_evoi_demande_solde) }}</span>
                </div>
                @if(client.note_solde) {
                  <div class="payment-item note">
                    <mat-icon>note</mat-icon>
                    <div>
                      <span class="payment-label">Note</span>
                      <span class="payment-value">{{ client.note_solde }}</span>
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Total des paiements -->
          <mat-card class="total-card">
            <mat-card-content>
              <div class="total-payment">
                <span class="total-label">Total des paiements</span>
                <span class="total-value">{{ formatAmount(client.montant_acompte_metre + client.montant_acompte_livraison + client.montant_solde) }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Produits -->
      <mat-tab label="Produits">
        <div class="tab-content">
          <mat-card class="products-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>inventory_2</mat-icon>
              <mat-card-title>Liste des produits</mat-card-title>
              <mat-card-subtitle>{{ client.produits.length || 0 }} produit(s)</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              @if(client.produits && client.produits.length > 0) {
                <mat-list>
                  @for(produit of client.produits; track produit.id) {
                    <mat-list-item>
                      <mat-icon matListItemIcon>check_circle</mat-icon>
                      <div matListItemTitle>{{ produit.nom }}</div>
                      <div matListItemLine>ID: {{ produit.id }}</div>
                    </mat-list-item>
                    <mat-divider></mat-divider>
                  }
                </mat-list>
              } @else {
                <div class="empty-state">
                  <mat-icon>inventory_2</mat-icon>
                  <p>Aucun produit associé à ce client</p>
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Commerciaux -->
      <mat-tab label="Commerciaux">
        <div class="tab-content">
          <mat-card class="commercials-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>group</mat-icon>
              <mat-card-title>Commerciaux assignés</mat-card-title>
              <mat-card-subtitle>{{ client.commerciaux.length || 0 }} commercial(aux)</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              @if(client.commerciaux && client.commerciaux.length > 0) {
                <mat-list>
                  @for(commercial of client.commerciaux; track commercial.id) {
                    <mat-list-item>
                      <mat-icon matListItemIcon>person</mat-icon>
                      <div matListItemTitle>{{ commercial.firstName }} {{ commercial.lastName }}</div>
                      <div matListItemLine>ID: {{ commercial.id }}</div>
                    </mat-list-item>
                    <mat-divider></mat-divider>
                  }
                </mat-list>
              } @else {
                <div class="empty-state">
                  <mat-icon>group</mat-icon>
                  <p>Aucun commercial assigné à ce client</p>
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>
} @else {
  <div class="error-container">
    <mat-icon>error_outline</mat-icon>
    <h2>Client non trouvé</h2>
    <p>Le client demandé n'existe pas ou n'a pas pu être chargé.</p>
    <button mat-raised-button color="primary" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Retour à la liste
    </button>
  </div>
}
