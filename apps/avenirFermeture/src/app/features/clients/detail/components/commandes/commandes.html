<div class="commandes">
  <div class="header">
    <div class="title">
      <mat-icon>inventory_2</mat-icon>
      <h2>Commandes</h2>
    </div>
    <button mat-raised-button color="primary" [routerLink]="['/one-client/create-commande']">
      <mat-icon>add</mat-icon>
      Créer une commande
    </button>
  </div>

  <div class="actions">
    <mat-form-field appearance="outline" class="search-field" subscriptSizing="dynamic">
      <mat-icon matIconPrefix>search</mat-icon>
      <input
        matInput
        placeholder="Rechercher une commande (référence, devis, fournisseur...)"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange($event)"
      />
      @if (searchTerm) {
        <button matIconSuffix matIconButton (click)="onSearchChange('')" aria-label="Effacer la recherche">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>

    <div class="filters">
      <mat-chip-listbox class="status-chips" [value]="selectedFilter" (change)="onFilterChange($event)">
        <mat-chip-option value="Tous">
          <span>Tous</span>
          <mat-icon>list</mat-icon>
        </mat-chip-option>
        <mat-chip-option value="En cours">
          <span>En cours</span>
          <mat-icon>schedule</mat-icon>
        </mat-chip-option>
        <mat-chip-option value="Terminées">
          <span>Terminées</span>
          <mat-icon>check_circle</mat-icon>
        </mat-chip-option>
        <mat-chip-option value="Annulées">
          <span>Annulées</span>
          <mat-icon>cancel</mat-icon>
        </mat-chip-option>
      </mat-chip-listbox>
    </div>

    <div class="stats-card">
      <mat-icon>bookmarks</mat-icon>
      <div class="stats-content">
        <span class="stats-label">Avenants</span>
        <span class="stats-value">{{ totalAvenants }}</span>
      </div>
    </div>
  </div>

  <mat-tree #tree [dataSource]="dataSource" [childrenAccessor]="childrenAccessor" class="orders-tree">
    <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding class="detail-node">
      <button matIconButton disabled aria-hidden="true" class="node-icon detail-icon">
        <mat-icon>notes</mat-icon>
      </button>
      <div class="details-content">
        <div class="details-grid">
          <div class="detail-card">
            <div class="detail-title">
              <mat-icon>receipt_long</mat-icon>
              <span>Résumé</span>
            </div>
            <div class="detail-row">
              <span class="label">Référence</span>
              <span class="value">{{ node.reference }}</span>
            </div>
            <div class="detail-row">
              <span class="label">N° devis</span>
              <span class="value">{{ node.details.devisNumero }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Commande interne</span>
              <span class="value">{{ node.details.commandeInterne }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Date de signature</span>
              <span class="value">{{ node.details.dateSignature }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Montant HT</span>
              <span class="value amount">{{ node.details.montantHt }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Montant TTC</span>
              <span class="value amount">{{ node.details.montantTtc }}</span>
            </div>
          </div>

          <div class="detail-card detail-card-products">
            <div class="detail-title">
              <mat-icon>category</mat-icon>
              <span>Produits</span>
            </div>
            @if (node.details.produits.length > 0) {
              <div class="product-list">
                @for (produit of node.details.produits; track $index) {
                  <div class="product-item">
                    <div class="product-header">
                      <span class="product-name">{{ produit.typeProduit }}</span>
                      <span class="product-qty">x{{ produit.quantite }}</span>
                    </div>
                    <div class="product-row">
                      <span class="label">État</span>
                      <span class="value status-value">
                        <span
                          class="status-dot"
                          [style.backgroundColor]="produit.etatCouleur || '#9ca3af'"
                        ></span>
                        {{ produit.etatProduit }}
                      </span>
                    </div>
                    <div class="product-row">
                      <span class="label">Avenant</span>
                      <span class="value">{{ produit.avenant ? 'Oui' : 'Non' }}</span>
                    </div>
                    @if (produit.note) {
                      <div class="product-row note-row">
                        <span class="label">Note</span>
                        <span class="value note">{{ produit.note }}</span>
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="empty-hint">Aucun produit associé.</div>
            }
          </div>

          <div class="detail-card">
            <div class="detail-title">
              <mat-icon>assignment</mat-icon>
              <span>Administratif</span>
            </div>
            <div class="detail-row">
              <span class="label">Type d’acompte</span>
              <span class="value">{{ node.details.typeAcompte }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Fournisseur</span>
              <span class="value">{{ node.details.fournisseur }}</span>
            </div>
          </div>

          <div class="detail-card">
            <div class="detail-title">
              <mat-icon>event</mat-icon>
              <span>Dates importantes</span>
            </div>
            <div class="detail-row">
              <span class="label">Date de métré</span>
              <span class="value">{{ node.details.dateMetre }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Date d’avenant</span>
              <span class="value">{{ node.details.dateAvenant || '-' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Date limite de pose</span>
              <span class="value">{{ node.details.dateLimitePose }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Date de livraison souhaitée</span>
              <span class="value">{{ node.details.dateLivraisonSouhaitee }}</span>
            </div>
          </div>

          <div class="detail-card detail-card-avenants">
            <div class="detail-title">
              <mat-icon>bookmarks</mat-icon>
              <span>Avenants</span>
            </div>
            <div class="avenants-summary">
              <div class="avenants-count">
                <span class="label">Total lié à la commande</span>
                <span class="value">{{ node.details.avenantsCount }}</span>
              </div>
              <div class="dp-panel">
                <span class="dp-label">Permis / DP</span>
                <span class="pill" [class.pill-yes]="node.details.permisDp" [class.pill-no]="!node.details.permisDp">
                  {{ node.details.permisDp ? 'Oui' : 'Non' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-tree-node>

    <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding matTreeNodeToggle class="order-node">
      <button matIconButton matTreeNodeToggle [attr.aria-label]="'Basculer ' + node.reference" class="node-icon">
        <mat-icon class="mat-icon-rtl-mirror">
          {{ tree.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
        </mat-icon>
      </button>
      <div class="order-content">
        <div class="order-header">
          <div class="order-ref">{{ node.reference }}</div>
          <div class="order-badges">
            <span
              class="status-pill"
              [class.status-in-progress]="node.status === 'En cours'"
              [class.status-done]="node.status === 'Terminée'"
              [class.status-cancelled]="node.status === 'Annulée'"
            >
              {{ node.status }}
            </span>
            <span class="order-amount">{{ node.details.montantTtc }}</span>
          </div>
        </div>
        <div class="order-submeta">
          <span>Devis {{ node.details.devisNumero }}</span>
          <span>Signature {{ node.details.dateSignature }}</span>
          <span>Fournisseur {{ node.details.fournisseur }}</span>
          <span>{{ node.details.produits.length }} produit(s)</span>
          <span>{{ node.details.avenantsCount }} avenant(s)</span>
        </div>
      </div>
    </mat-tree-node>
  </mat-tree>

  @if (isLoading) {
    <div class="empty-state">
      <mat-icon>hourglass_top</mat-icon>
      <div>
        <div class="empty-title">Chargement des commandes...</div>
        <div class="empty-subtitle">Merci de patienter.</div>
      </div>
    </div>
  } @else if (dataSource.length === 0) {
    <div class="empty-state">
      <mat-icon>inventory_2</mat-icon>
      <div>
        <div class="empty-title">Aucune commande trouvée</div>
        <div class="empty-subtitle">Ajustez la recherche ou les filtres.</div>
      </div>
    </div>
  }
</div>
